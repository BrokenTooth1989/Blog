# 移动网络下的动作格斗类PVP游戏网络同步方案
**作者: fergus (zfengzhen@gmail.com)**    
   

移动网络下的动作格斗类PVP游戏特性  
1、移动网络 --> 无线信道，信道的切换、干扰以及衰弱导致比有线网络丢包率高  
2、动作格斗类 --> 快速响应  
3、PVP方案 --> 权威服务器，帧同步
   
需要关注的两个特性：**丢包**和**时延**  
   
在此基础上提出了[逻辑层被动拉取式智能多发可靠UDP帧同步PVP方案](https://zh.wikipedia.org/wiki/%E6%97%B6%E5%BB%B6)  

##丢包  
![](https://github.com/zfengzhen/Blog/blob/master/img/network_pkg_loss.jpg)  
**丢包会导致数据重传**  

**TCP重传处理**  
TCP发生重传时，没有任何办法可以绕过TCP的重传机制，linux下的RTO（Retransmission TimeOut）最小值是200ms。当网络发生抖动时，我们只能被动接受高时延。这都是源于TCP是一个君子协议，TCP拥塞控制机制建立在传统有线网络丢包是拥塞唯一原因的基础上，如果丢包了，TCP认为网络容量不够了，不能立马重发，免得网络变得更加拥堵。  

**UDP重传处理**  
UDP需要自己定义丢包后的处理机制，通过浪费点带宽（移动网络下还不一定浪费了带宽），让时延可控。  

##时延  
参见[维基百科](https://zh.wikipedia.org/wiki/%E6%97%B6%E5%BB%B6)  
参见《计算机网络--自顶向下方法》  
![](https://github.com/zfengzhen/Blog/blob/master/img/network_delay.jpg)  
##游戏PVP方案  
   
###权威服务器  
游戏客户端把输入（按键，命令）发送到服务器，服务器来运行这个游戏，然后你把结果返回给客户端，客户端进行渲染表现。这就是常说的权威服务器，因为游戏世界中发生的一切都在服务器中进行。  
   
由于网络时延，服务器上的状态和各个客户端之间的状态和表现很难确定是在什么时间点是稳定一致的。  
   
###帧同步模式  
游戏客户端按照帧的概念来同步执行，关键在于**确定性**，不同游戏客户端只要每帧的输入相同，就一定会产生一致性的结果。  
   
###对比  

<table>
    <tr>
        <td>**权威服务器模式**</td>
        <td>**帧同步模式**</td>
    </tr>
    <tr>
        <td>**优势：**</td>
        <td>**短处：**</td>
    </tr>
    <tr>
        <td>1、反作弊天然支持</td>
        <td>1、反作弊相对麻烦（帧效验，天花板或者全局推演），可解决</td>
    </tr>
    <tr>
        <td>2、战斗逻辑只需要服务器更新</td>
        <td>2、战斗逻辑需要所有客户端及时更新</td>
    </tr>
    <tr>
        <td>3、可以做世界这种有视野概念玩法，按区域刷新状态</td>
        <td>3、只能做单局概念玩法，需要全视野所有操作进行推演</td>
    </tr>
    <tr>
        <td>4、可以做视野玩法</td>
        <td>4、视野数据客户端全有，客户端本地屏蔽，防视野挂难</td>
    </tr>
    <tr>
        <td>**短处：**</td>
        <td>**优势：**</td>
    </tr>
    <tr>
        <td>1、因为要协调客户端服务器协议等，开发效率慢</td>
        <td>1、开发效率快</td>
    </tr>
    <tr>
        <td>2、服务器承载低（逻辑运算量相对大）</td>
        <td>2、服务器承载高</td>
    </tr>
    <tr>
        <td>3、录像相对难实现</td>
        <td>3、录像天然支持（跨版本录像需要额外考虑）</td>
    </tr>
    <tr>
        <td>4、客户端的状态和表现很难确定在什么时间点是一致的</td>
        <td>4、客户端可以做公平竞技</td>
    </tr>
    <tr>
        <td>5、网络流量相对较大</td>
        <td>5、网络流量相对较小</td>
    </tr>
    <tr>
        <td>**代表作：**</td>
        <td>**代表作：**</td>
    </tr>
    <tr>
        <td>各端游以及mmo手游</td>
        <td>王者荣耀，火影忍者</td>
    </tr>
<table>
   
##逻辑层被动拉取式智能多发可靠UDP帧同步PVP方案  
   
###关键字拆解  
![](https://github.com/zfengzhen/Blog/blob/master/img/network_pvp.jpg)
   
注：这里的帧同步采用不锁帧的模式，不考虑绝对公平竞技，网络卡的玩家不影响对手，逻辑帧按服务器时间轴驱动。

